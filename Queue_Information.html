<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>State 174 科技佇列排行榜</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #1e1e1e;
      color: #ffffff;
      padding: 20px;
      margin: 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      padding: 12px;
      border: 1px solid #444;
      text-align: left;
    }
    th {
      background-color: #333;
    }
    tr:nth-child(even) {
      background-color: #2a2a2a;
    }
    tr.waiting {
      background-color: #1e3d1e;
    }
    tr.deferred {
      background-color: #3d1e1e;
    }
    input[type="text"], select {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      margin-bottom: 20px;
      font-size: 16px;
      background: #2e2e2e;
      color: #fff;
      border: 1px solid #555;
      border-radius: 5px;
    }
    @media (max-width: 768px) {
      table, th, td {
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <h1 id="title"></h1>
  <select id="languageSelector"></select>
  <input type="text" id="search" placeholder="">
  <table id="queueTable">
    <thead>
      <tr id="tableHeader"></tr>
    </thead>
    <tbody></tbody>
  </table>
  <script>
    let lang = navigator.language.startsWith('zh') ? 'zh' : navigator.language.startsWith('ko') ? 'ko' : 'en';

    const text = {
      zh: {
        title: "State 174 科技佇列排行榜",
        searchPlaceholder: "搜尋玩家、聯盟、狀態或目的...",
        headers: ["佇列", "玩家名稱", "聯盟", "升級項目", "狀態", "職位", "送出時間"]
      },
      en: {
        title: "State 174 Tech Queue Ranking",
        searchPlaceholder: "Search player, alliance, state, or purpose...",
        headers: ["Queue", "Player", "Alliance", "Upgrade Purpose", "State", "Title", "Time"]
      },
      ko: {
        title: "State 174 기술 대기열 순위",
        searchPlaceholder: "플레이어, 연맹, 상태 또는 목적 검색...",
        headers: ["대기열", "플레이어", "연맹", "업그레이드 목적", "상태", "직책", "제출 시간"]
      }
    };

    function updateLanguage(l) {
      lang = l;
      document.getElementById("title").textContent = text[lang].title;
      document.getElementById("search").placeholder = text[lang].searchPlaceholder;

      const headerRow = document.getElementById("tableHeader");
      headerRow.innerHTML = "";
      text[lang].headers.forEach(header => {
        const th = document.createElement("th");
        th.textContent = header;
        headerRow.appendChild(th);
      });
    }

    const selector = document.getElementById("languageSelector");
    const options = { zh: "中文", en: "English", ko: "한국어" };
    for (const key in options) {
      const opt = document.createElement("option");
      opt.value = key;
      opt.textContent = options[key];
      if (key === lang) opt.selected = true;
      selector.appendChild(opt);
    }
    selector.addEventListener("change", () => {
      updateLanguage(selector.value);
    });

    updateLanguage(lang);

    async function loadCSV() {
      const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vTbNPGMKMK1K_3kUCB8KNYUVdZXJvVddkzkDNZzN8rlxkKHeUOw-Y54NSiYzq0D5Upf9tZxw5tP1fOv/pub?gid=1929858160&single=true&output=csv');
      const text = await response.text();
      const rows = text.split('\n').slice(1).map(r => r.split(','));

      const roles = [
        "Secretary Of Construction",
        "Vice Presidet",
        "War Commander",
        "Secretary Of Sciene"
      ];

      const categorized = {};
      roles.forEach(role => categorized[role] = []);
      rows.forEach(row => {
        const role = row[1];
        if (categorized[role]) categorized[role].push(row);
      });

      function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
      }

      let queueNum = 1;
      const tbody = document.querySelector("#queueTable tbody");
      roles.forEach(role => {
        const shuffled = shuffle(categorized[role]);
        shuffled.forEach(row => {
          if (row.length < 7) return;
          const tr = document.createElement("tr");
          const state = row[6];
          tr.className = state === '等待中' ? 'waiting' : (state === '暫緩' ? 'deferred' : '');
          tr.innerHTML = `
            <td>${queueNum++}</td>
            <td>${row[3]}</td>
            <td>${row[2]}</td>
            <td>${row[4]}</td>
            <td>${state}</td>
            <td>${row[1]}</td>
            <td>${row[0]}</td>
          `;
          tbody.appendChild(tr);
        });
      });
    }

    document.getElementById("search").addEventListener("input", function () {
      const search = this.value.toLowerCase();
      document.querySelectorAll("#queueTable tbody tr").forEach(tr => {
        const match = [...tr.children].some(td => td.textContent.toLowerCase().includes(search));
        tr.style.display = match ? "" : "none";
      });
    });

    loadCSV();
  </script>
</body>
</html>
